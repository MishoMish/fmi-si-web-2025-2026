# Автентикация — Регистрация, логин и сесии

## Обща архитектура

```
homepage.html ─── myscript.js ──→ session.php ──→ Db.php
                                      │              │
                                 Session.php     MySQL (PDO)
                                      │
                                   User.php
```

**Файлове:**

| Файл | Роля |
|------|------|
| `homepage.html` | Frontend — форми, бутони |
| `myscript.js` | Логика на клиента — fetch, DOM |
| `bootstrap.php` | Autoloader, сесия, error handler |
| `session.php` | API за логин/логаут/проверка |
| `user.php` | API за регистрация |
| `classes/Db.php` | Връзка с базата |
| `classes/User.php` | Модел за потребител |
| `classes/Session.php` | Управление на сесии |

## Стъпка 1: Bootstrap

```php
<?php
// bootstrap.php
session_start();
header('Content-Type: application/json');

spl_autoload_register(function ($className) {
    $classDirs = ["classes", "classes/models", "classes/controllers"];
    foreach ($classDirs as $dir) {
        $filePath = "./{$dir}/{$className}.php";
        if (file_exists($filePath)) {
            require_once $filePath;
            return;
        }
    }
});

set_exception_handler(function ($exception) {
    http_response_code(500);
    echo json_encode(['error' => 'Internal server error']);
    error_log($exception->getMessage());
});
?>
```

## Стъпка 2: Регистрация

### Процесът

1. Потребителят попълва формата (email, password, name)
2. JavaScript изпраща POST заявка към `user.php`
3. PHP хешира паролата и я записва в БД
4. Потребителят се пренасочва или получава съобщение

### user.php

```php
<?php
require_once 'bootstrap.php';

switch ($_SERVER['REQUEST_METHOD']) {
    case 'POST': // Регистрация
        $email = $_POST['email'] ?? '';
        $password = $_POST['password'] ?? '';
        $name = $_POST['name'] ?? '';

        // Валидация
        if (empty($email) || empty($password) || empty($name)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'Missing fields']);
            exit;
        }

        $user = new User(null, $email, $name, null);
        $user->setPassword($password); // password_hash()

        $connection = (new Db())->getConnection();
        $stmt = $connection->prepare(
            "INSERT INTO users (email, password, name) VALUES (:email, :password, :name)"
        );
        $stmt->execute([
            'email' => $user->getEmail(),
            'password' => $user->getHashedPassword(),
            'name' => $user->getName(),
        ]);

        $userId = $connection->lastInsertId();
        $_SESSION['user_id'] = $userId;

        echo json_encode(['success' => true, 'email' => $user->getEmail()]);
        break;
}
?>
```

## Стъпка 3: Логин

### Процесът

1. Потребителят въвежда email и парола
2. JavaScript изпраща POST с FormData или JSON
3. PHP търси потребителя по email, верифицира паролата
4. При успех — записва `user_id` в `$_SESSION`

### session.php

```php
<?php
require_once 'bootstrap.php';

switch ($_SERVER['REQUEST_METHOD']) {
    case 'GET':
        // Проверка на статуса
        echo json_encode(['loggedIn' => Session::isUserLoggedIn()]);
        break;

    case 'POST':
        // Логин
        $email = $_POST['email'];
        $password = $_POST['password'];

        $connection = (new Db())->getConnection();
        $stmt = $connection->prepare("SELECT * FROM users WHERE email = :email");
        $stmt->execute(['email' => $email]);
        $userData = $stmt->fetch();

        $success = $userData && password_verify($password, $userData['password']);

        if ($success) {
            Session::logUser(User::fromArray($userData));
        }

        echo json_encode(['success' => $success]);
        break;

    case 'DELETE':
        // Логаут
        session_destroy();
        echo json_encode(['success' => true]);
        break;
}
?>
```

## Стъпка 4: Frontend логика

### Проверка на логин статус при зареждане

```js
function loadLoginStatus() {
    fetch('./session.php', {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
    })
    .then(res => res.json())
    .then(response => {
        if (response.loggedIn) {
            // Показване на бутон "Изход"
            document.getElementById('logout-button').style.display = 'inline';
            document.getElementById('login-button').style.display = 'none';
        } else {
            // Показване на бутон "Вход"
            document.getElementById('login-button').style.display = 'inline';
            document.getElementById('logout-button').style.display = 'none';
        }
    });
}

// Извикване при зареждане на страницата
loadLoginStatus();
```

### Изпращане на логин формата

```js
document.querySelector('#login-form form')
    .addEventListener('submit', event => {
        event.preventDefault();

        let formData = new FormData(event.target);

        fetch('./session.php', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                location.reload(); // Презарежда за обновяване на UI
            } else {
                alert('Грешен имейл или парола!');
            }
        });
    });
```

### Показване / скриване на логин форма

```js
document.getElementById('login-button')
    .addEventListener('click', () => {
        document.getElementById('login-form').style.display = 'block';
    });

document.getElementById('close-button')
    .addEventListener('click', () => {
        document.getElementById('login-form').style.display = 'none';
    });
```

## Поток на данните (обобщение)

```
                    РЕГИСТРАЦИЯ
user.php ← POST (email, password, name)
   │
   ├── password_hash() → INSERT INTO users
   ├── $_SESSION['user_id'] = lastInsertId()
   └── return { success: true }

                      ЛОГИН
session.php ← POST (email, password)
   │
   ├── SELECT FROM users WHERE email = ?
   ├── password_verify() → true/false
   ├── $_SESSION['user_id'] = user.id
   └── return { success: true/false }

                   ПРОВЕРКА
session.php ← GET
   │
   └── return { loggedIn: isset($_SESSION['user_id']) }

                     ЛОГАУТ
session.php ← DELETE
   │
   ├── session_destroy()
   └── return { success: true }
```

## Сигурност — обобщение

| Заплаха | Защита |
|---------|--------|
| SQL Injection | Prepared Statements (PDO) |
| XSS | `htmlspecialchars()` при изход |
| Незащитени пароли | `password_hash()` + `password_verify()` |
| Директен достъп до класове | `.htaccess` — `Deny from all` |
| CSRF | Токени за формуляри (напреднало) |
| Сесийни атаки | `session_regenerate_id()` при логин |
